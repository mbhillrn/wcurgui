================================================================================
CLAUDE LOOK HERE - MBTC-DASH Development Checklist
================================================================================

Last Updated: 2026-01-30
Current Version: 0.2.3

================================================================================
** ACTIVE REFACTOR - SESSION CACHE ARCHITECTURE **
================================================================================

PROBLEM: Current DB-per-peer-query approach is slow. Opening/closing SQLite
connection for each of 20+ peers on every request adds latency.

SOLUTION: Session-based in-memory cache. DB only for historical stats.

NEW ARCHITECTURE:
  1. Server starts
  2. getpeerinfo runs → TABLE DISPLAYS IMMEDIATELY (all getpeerinfo columns)
     - Geo columns show "Stalking..." or blank
  3. Background: For each peer, fetch geo from API (1.5s each)
     - As each completes, that row's geo columns update via SSE
     - Store in SESSION CACHE (Python dict) - NOT database
  4. Once geo fetched for an IP this session, DON'T fetch again
  5. Every 10s: getpeerinfo again
     - Only update CHANGED fields (not everything)
     - New peer? Add row, queue geo lookup
     - Peer gone? Remove row, show in Recent Updates WITH IP
  6. Background (separate, non-blocking): Save historical stats to DB
     - first_seen, last_seen, times_seen
     - Does NOT block the UI

SESSION CACHE LOGIC:
  - geo_cache = {"98.227.252.166": {continent, country, city, ...}, ...}
  - Peer connects → check cache → if not found, queue API lookup
  - Peer disconnects → keep in cache (might reconnect)
  - Session ends → cache cleared (fresh start next time)

DATABASE PURPOSE (historical only, lazy/background):
  - first_seen: First time we ever saw this IP
  - last_seen: Most recent time we saw this IP
  - times_seen: How many sessions we've seen this IP
  - NOT used for geo data (that's session cache only now)

ADDRMAN NOTE: The addrman feature was NOT causing the 40s delay.
Can add back later in non-blocking way if desired.

================================================================================
USER SETTINGS / DECISIONS
================================================================================

Database Location: ./data/ folder (local to project)
Database stores: IP only (no port) for geo cache
  - Multiple peers can share same IP on different ports
  - Display full ip:port in tables
  - Show warning when multiple peers share same IP

Web Dashboard Layout (top to bottom):
  1. MAP - shows peer locations
  2. Main Peer Table - full peer list
  3. Recent Changes Table - adds/removes in last 20 seconds (same columns as main)

Map Library: Professional, free, lightweight (Leaflet.js)
Web Port: Fixed 58333 (fallback to random if taken)
Framework: FastAPI (not Flask)
Auth: Username "admin", random 5-char password per session

Addrman Cache: REMOVED (was causing 40+ second startup delay)
  - Was using `getnodeaddresses 0` to get all known addresses
  - Can discuss adding back in a non-blocking way if desired

Python Dependencies: Installed in local ./venv/ folder
  - Terminal packages: rich, requests
  - Web packages: fastapi, uvicorn, jinja2, sse-starlette
  - Easy uninstall: just delete ./venv/ folder

================================================================================
CRITICAL REQUIREMENTS (FROM PROJ-PLAN)
================================================================================

[!] PEER LIST MUST:
  - Show table IMMEDIATELY with all peers
  - Update locations in REAL TIME as geo lookups complete
  - Do NOT wait for all geo lookups to finish
  - New peers that connect mid-session MUST trigger geo lookups
  - 'q' should quit (not require Ctrl+C)
  - Table should be scrollable

================================================================================
GEO-LOOKUP LOGIC
================================================================================

Address Classification:
  [ ] Onion (.onion) -> PRIVATE LOCATION, skip API
  [ ] I2P (.i2p) -> PRIVATE LOCATION, skip API
  [ ] CJDNS (fc/fd prefix) -> PRIVATE LOCATION, skip API
  [ ] RFC1918 IPv4 (10.x, 172.16-31.x, 192.168.x) -> PRIVATE LOCATION, skip API
  [ ] Private IPv6 -> PRIVATE LOCATION, skip API
  [ ] Public IPv4/IPv6 -> Attempt geo lookup

Future Map Placement:
  - PRIVATE LOCATION -> Antarctica
  - LOCATION UNAVAILABLE -> North Pole
  - Public geo -> real lat/lon

================================================================================
GEO CACHE STRATEGY
================================================================================

When public IP appears:
  1. If in DB with geo_status = GEO_OK -> Use cached, NO API call
  2. If in DB with geo_status = PRIVATE -> Use cached, NO API call
  3. If in DB with geo_status = GEO_UNAVAILABLE:
     - Retry ONLY if: now - geo_last_lookup > retry_interval
     - Retry cadence: 1 day -> 3 days -> 7 days -> forever 7 days
  4. If NOT in DB -> Call API once, insert row

Reset options needed (future):
  [ ] Reset only unavailable entries
  [ ] Reset entire geo cache

================================================================================
DISPLAY COLUMNS (Web Dashboard) - ALL SEPARATE, NO COMBINING
================================================================================

** USER REQUIREMENT: All columns separate for now. Can combine later. **
** Can ADD columns, but do NOT subtract/remove without asking. **

COLUMN ORDER (left to right):
  1.  Peer ID (getpeerinfo)
  2.  Network type (getpeerinfo) - ipv4, ipv6, onion, i2p, cjdns
  3.  IP (getpeerinfo)
  4.  Port (getpeerinfo)
  5.  Direction (getpeerinfo) - IN/OUT
  6.  Subver (getpeerinfo) - user agent
  7.  City (ip-api) - loads second
  8.  Region (ip-api)
  9.  RegionName (ip-api)
  10. Country (ip-api)
  11. CountryCode (ip-api)
  12. Continent (ip-api)
  13. ContinentCode (ip-api)
  14. Bytes Sent (getpeerinfo)
  15. Bytes Recv (getpeerinfo)
  16. Ping (getpeerinfo) - ms
  17. ConnTime (getpeerinfo) - formatted duration
  18. Version (getpeerinfo)
  19. ConnType (getpeerinfo)
  20. Services (getpeerinfo) - abbreviated
  21. Lat (ip-api)
  22. Lon (ip-api)
  23. ISP (ip-api)
  24. First Seen (database) - loads last
  25. Last Seen (database)
  26. Times Seen (database)

IP-API URL:
  http://ip-api.com/json/{ip}?fields=continent,continentCode,country,countryCode,region,regionName,city,lat,lon,isp,query

NETWORK TYPE COLORS (in table rows):
  - ipv4: yellow
  - ipv6: orange
  - onion/tor: mild red
  - i2p: light blue
  - cjdns: light pink
  ** If colors conflict with other UI elements, use different shades **

MAP STATUS INDICATOR (corner of map):
  - Orange circle + "Updating..." while geo lookups in progress
  - Green circle + "Updated!" when all geo lookups complete
  - Red circle + error message if something fails

Sorting: Default by Peer ID (preserves connection order)

================================================================================
DATABASE STORAGE (SIMPLIFIED - Historical Only)
================================================================================

** NEW: DB is for historical stats ONLY, not geo caching **
** Geo data is session-cached in memory, fetched fresh each session **

New simplified schema (peers_history table):
  - ip (PRIMARY KEY) - IP address only, no port
  - first_seen - First time we EVER saw this IP (timestamp)
  - last_seen - Most recent time we saw this IP (timestamp)
  - times_seen - How many sessions we've seen this IP (integer)
  - network_type - ipv4, ipv6, onion, i2p, cjdns (for reference)

OLD fields (REMOVED from DB, now session-cached):
  - geo_status (not needed, just fetch fresh)
  - country, countryCode, region, city, etc (session cache)
  - geo_last_lookup, geo_retry_count (not needed)

Do NOT store (changes too frequently):
  - Most getpeerinfo stats
  - Anything that changes every 10 seconds

================================================================================
TODO CHECKLIST
================================================================================

** ACTIVE REFACTOR - SESSION CACHE ARCHITECTURE **

PHASE 1 - ARCHITECTURE REFACTOR:
  [ ] Remove DB queries from critical /api/peers path
  [ ] Implement in-memory geo_cache dict
  [ ] getpeerinfo data displays IMMEDIATELY (no DB wait)
  [ ] Geo columns show "Stalking..." until API returns
  [ ] Background geo worker populates session cache
  [ ] SSE updates individual cells as geo arrives
  [ ] Only update CHANGED fields on 10s refresh (not everything)

PHASE 2 - COLUMNS (ALL SEPARATE):
  [ ] Add all getpeerinfo columns (see DISPLAY COLUMNS section)
  [ ] Add all ip-api columns SEPARATELY (continent, continentCode, etc)
  [ ] Add historical columns (first_seen, last_seen, times_seen)
  [ ] Update API call to use new fields parameter
      http://ip-api.com/json/{ip}?fields=continent,continentCode,country,countryCode,region,regionName,city,lat,lon,isp,query

PHASE 3 - NETWORK TYPE COLORS:
  [ ] ipv4 rows: yellow tint
  [ ] ipv6 rows: orange tint
  [ ] onion rows: mild red tint
  [ ] i2p rows: light blue tint
  [ ] cjdns rows: light pink tint
  [ ] Check colors don't conflict with other UI elements

PHASE 3B - MAP STATUS INDICATOR:
  [ ] Add status indicator to corner of map
  [ ] Orange circle + "Updating..." while geo lookups in progress
  [ ] Green circle + "Updated!" when all geo complete
  [ ] Red circle + error message if something fails

PHASE 4 - RECENT UPDATES PANEL FIX:
  [ ] Store IP address when peer connects (so we have it when they disconnect)
  [ ] When peer disconnects, show "Peer X (IP) disconnected" (not just ID)
  [ ] Recent Updates should show: Peer ID + IP + "connected" or "disconnected"

PHASE 5 - STATUS BAR FIX:
  [ ] Only show networks we're actually connected to
  [ ] If no cjdns peers, don't show "cjdns: 0, in: 0, out: 0"
  [ ] If connected to a network but 0 peers, DO show it
  [ ] Determine connected networks from getnetworkinfo reachable field

PHASE 6 - DATABASE (HISTORICAL ONLY):
  [ ] Simplify DB schema: just ip, first_seen, last_seen, times_seen
  [ ] Update DB in background (never blocks UI)
  [ ] Load historical stats separately from main peer data
  [ ] times_seen increments each session we see the IP

TERMINAL PEER LIST (lower priority):
  [x] Show table immediately without waiting for geo
  [x] Background thread(s) for geo lookups
  [x] Live update display as geo completes
  [x] Detect new peers mid-session, queue geo lookups
  [x] 'q' quits properly
  [ ] Scrolling works (terminal limits rows, shows "X more peers")

PREREQS/DEPENDENCIES:
  [x] Add FastAPI to prereqs check
  [x] Add uvicorn to prereqs check
  [x] Add any other web dependencies (jinja2, sse-starlette)
  [x] Offer to install missing deps (da.sh prompts to install)
  [ ] Track what THIS program installs (for uninstaller)

UNINSTALLER:
  [ ] Create tracking of installed dependencies
  [ ] Uninstaller removes only what we installed
  [ ] Does not affect pre-existing packages

WEB DASHBOARD (existing):
  [x] FastAPI server (not Flask)
  [x] Dynamic port selection (49152-65535)
  [x] Port conflict detection
  [x] Single password auth for remote access
  [x] Detect local IPs/interfaces
  [x] Show user correct URL to access
  [x] Map at top (Leaflet.js with CartoDB dark tiles)
  [x] Main peer table
  [x] Recent changes table (20 second window)
  [x] Clean shutdown on Ctrl+C

DOCUMENTATION:
  [ ] Update PROJECT_PROGRESS.md
  [ ] Update PROJ-Plan with [DONE] markers
  [ ] Update PREREQS.md
  [ ] Update README.md

================================================================================
COMPLETED ITEMS
================================================================================

[x] Config saved to ./data/config.conf (2026-01-29)
[x] Database path set to ./data/peers.db (2026-01-29)
[x] Removed unnecessary backwards compatibility code (2026-01-29)
[x] Peer list shows immediately - no blocking on geo lookups (2026-01-29)
[x] Background thread for geo lookups (2026-01-29)
[x] Live display updates as geo completes (2026-01-29)
[x] New peers queued for geo lookup automatically (2026-01-29)
[x] RFC1918 private IP detection added (2026-01-29)
[x] 'q' properly quits peer list (2026-01-29)
[x] Ctrl+C handled gracefully (2026-01-29)
[x] CLAUDE-CHECKLIST.txt created (2026-01-29)
[x] Addrman (AM) column added to terminal peer list (2026-01-30)
[x] FastAPI web dashboard created (2026-01-30)
[x] Web dashboard - Leaflet map with peer locations (2026-01-30)
[x] Web dashboard - Main peer table with sorting (2026-01-30)
[x] Web dashboard - Recent changes table (20s window) (2026-01-30)
[x] Web dashboard - Server-Sent Events for real-time updates (2026-01-30)
[x] Web dashboard - Dynamic port selection (49152-65535) (2026-01-30)
[x] Web dashboard - Session password auth (2026-01-30)
[x] Prerequisites updated with FastAPI/uvicorn/jinja2/sse-starlette (2026-01-30)
[x] Python dependencies now use local ./venv/ folder (2026-01-30)
[x] Fixed prereqs flow - proper handling when install fails (2026-01-30)
[x] Added terminal-only fallback option (2026-01-30)
[x] Documented addrman is session-only (in memory) (2026-01-30)
[x] Updated stats bar - removed geo/private, added timer/time, in/out counts (2026-01-30)
[x] Updated table columns per user spec (2026-01-30)
[x] Updated startup screen with clearer instructions (2026-01-30)
[x] Removed addrman to fix slow startup (was 40+ seconds) (2026-01-30)
[x] Added troubleshooting note about old browser tabs (2026-01-30)

================================================================================
